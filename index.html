<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>גליל – לוח יריבות (מפה)</title>
  <style>
    :root {
      --bg0:#040812; --bg1:#071427;
      --glass: rgba(18, 30, 48, .55);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(58,167,255,.22);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --accent: #3aa7ff; --accent2:#79d2ff;
      --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Arial,"Noto Sans Hebrew",sans-serif;
      background:
        radial-gradient(1200px 600px at 70% 20%, rgba(58,167,255,.16), transparent 55%),
        radial-gradient(900px 500px at 20% 15%, rgba(121,210,255,.10), transparent 50%),
        linear-gradient(180deg,var(--bg1),var(--bg0));
      overflow-x:hidden;
    }
    .bg{position:fixed;inset:0;pointer-events:none;background:url("assets/bg-tree.svg") center/cover no-repeat;opacity:.30}
    .bg::after{content:"";position:absolute;inset:0;background:radial-gradient(900px 600px at 50% 40%, rgba(0,0,0,.10), rgba(0,0,0,.65))}
    .wrap{position:relative;min-height:100%}
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);background:linear-gradient(90deg, rgba(10,18,32,.55), rgba(10,18,32,.35));border-bottom:1px solid var(--stroke)}
    .bar{max-width:1320px;margin:0 auto;padding:14px 18px;display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:4px;min-width:260px}
    .title h1{margin:0;font-size:22px}
    .title .sub{color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);border-radius:999px;color:var(--muted);font-size:12px;white-space:nowrap}
    .pill a{color:var(--accent2);text-decoration:none}
    .pill a:hover{text-decoration:underline}

    main{max-width:1320px;margin:16px auto 26px;padding:0 14px;display:grid;grid-template-columns:420px 1fr;gap:16px}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, var(--glass), rgba(7,15,26,.35));border-radius:18px;box-shadow:0 20px 70px rgba(0,0,0,.35);overflow:hidden}
    .cardHeader{padding:14px 14px 10px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardHeader h2{margin:0;font-size:16px}
    .cardHeader small{color:var(--muted2);font-size:12px}
    .cardBody{padding:12px 14px 14px}
    label{font-size:13px;color:var(--muted)}
    input[type="text"],select{width:100%;margin-top:6px;padding:10px 10px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);outline:none}
    input::placeholder{color:rgba(255,255,255,.45)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{cursor:pointer;user-select:none;padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;transition:.15s}
    .chip:hover{border-color:var(--stroke2);color:var(--text)}
    .chip.active{border-color:rgba(58,167,255,.55);background:rgba(58,167,255,.12);color:var(--text);box-shadow:0 0 0 3px rgba(58,167,255,.10) inset}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:14px;font-weight:600;transition:.15s}
    button:hover{border-color:var(--stroke2);background:rgba(58,167,255,.10)}
    button.primary{border-color:rgba(58,167,255,.55);background:rgba(58,167,255,.12)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .stats{margin-top:12px;padding:10px 12px;border-radius:14px;border:1px dashed rgba(255,255,255,.14);background:rgba(0,0,0,.15);color:var(--muted);font-size:12px;line-height:1.6}
    .err{margin-top:10px;padding:10px 12px;border:1px solid rgba(251,191,36,.35);border-radius:14px;background:rgba(251,191,36,.08);color:rgba(255,255,255,.90);font-size:12px;line-height:1.5}
    .diag{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(58,167,255,.20);background:rgba(58,167,255,.06);color:rgba(210,240,255,.92);font-size:12px;line-height:1.5;display:none}
    .diag code{color:#a7e3ff}

    .map{position:relative;min-height:720px}
    .mapInner{position:relative;height:720px;border-radius:18px;overflow:hidden;border:1px solid var(--stroke);background:radial-gradient(700px 420px at 50% 50%, rgba(58,167,255,.10), rgba(0,0,0,.15))}
    .mapGrid{position:absolute;inset:0;background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,.07) 1px, transparent 0);background-size:22px 22px;opacity:.25}
    .mapTitle{position:absolute;top:14px;right:14px;left:14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;pointer-events:none}
    .mapTitle h2{margin:0;font-size:18px}
    .mapTitle .hint{color:var(--muted2);font-size:12px;text-align:left}

    .node{position:absolute;width:210px;transform:translate(-50%,-50%);border-radius:16px;border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(15,26,42,.75), rgba(9,16,27,.55));
      box-shadow:0 16px 44px rgba(0,0,0,.35);padding:12px 12px 10px;cursor:pointer;transition:.16s}
    .node:hover{border-color:rgba(58,167,255,.50);box-shadow:0 18px 52px rgba(0,0,0,.42)}
    .node .name{font-weight:800;font-size:14px;line-height:1.2;margin-bottom:6px}
    .node .meta{color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .node .meta2{font-size:12px;opacity:.95;margin-top:6px;color:rgba(210,240,255,.92)}
    .node .cta{margin-top:8px;color:var(--accent2);font-size:12px}
    .node.center{width:280px;border-color:rgba(58,167,255,.55);background:linear-gradient(180deg, rgba(35,86,120,.70), rgba(10,18,32,.55));
      box-shadow:0 26px 80px rgba(58,167,255,.10), 0 18px 64px rgba(0,0,0,.45)}
    .node.center .name{font-size:16px}
    .line{position:absolute;height:1px;background:rgba(58,167,255,.16);transform-origin:0 50%;pointer-events:none}

    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.12)}
    th,td{padding:10px 12px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
    th{text-align:right;color:rgba(255,255,255,.85);background:rgba(255,255,255,.04);position:sticky;top:0;z-index:1}
    tr:hover td{background:rgba(58,167,255,.06)}
    .tables{margin-top:12px}
    .tableWrap{border-radius:14px;overflow:hidden}
    .tableWrap.noScroll{max-height:none!important;overflow:visible!important}

    select, option{background-color: rgba(8,22,38,0.95);color:var(--text)}
    select:focus{outline:2px solid rgba(94,212,255,0.55);outline-offset:2px}
    .roundRow{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    .roundRow .btnMini{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.16);background:rgba(18,45,72,0.55)}
    .roundRow .btnMini:hover{background:rgba(18,45,72,0.75)}

    @media (max-width:1100px){main{grid-template-columns:1fr}.mapInner{height:640px}.map{min-height:640px}}
    @media (max-width:560px){.node{width:180px}.node.center{width:230px}.row{grid-template-columns:1fr}.row3{grid-template-columns:1fr}th,td{font-size:12px;padding:9px 8px}}
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="wrap">
    <header>
      <div class="bar">
        <div class="title">
          <h1 id="pageTitle">גליל עליון במרכז — כל היריבות מסביב</h1>
          <div class="sub" id="leagueLine">טוען נתונים…</div>
        </div>
        <div class="pill">
          <span id="sourceLine">מקור: GitHub Pages</span>
          <span>•</span>
          <a id="debugLink" href="debug_endpoints.json" target="_blank" rel="noreferrer">debug_endpoints.json</a>
        </div>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="cardHeader">
          <h2>פילטרים</h2>
          <small id="metaSmall">—</small>
        </div>
        <div class="cardBody">
          <div class="row">
            <div>
              <label>בחר מחזור</label>
              <div class="roundRow">
                <button id="roundPrev" class="btnMini" type="button">← מחזור קודם</button>
                <select id="roundSelect"></select>
                <button id="roundNext" class="btnMini" type="button">מחזור הבא →</button>
              </div>
            </div>
            <div>
              <label>הדגש קבוצה (שם חלקי)</label>
              <input id="teamInput" type="text" placeholder="למשל: גליל / חיפה / נהריה" />
            </div>
          </div>

          <div class="row3">
            <div>
              <label>רק משחקים של הקבוצה</label>
              <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                <input id="onlyTeam" type="checkbox" style="transform:scale(1.1);" />
                <span class="muted">מסנן את הטבלאות</span>
              </div>
            </div>
            <div>
              <label>בחר יריבה במפה</label>
              <div class="muted" style="margin-top:10px;">לחיצה על בועה תסנן</div>
            </div>
            <div>
              <label>איפוס</label>
              <div class="btns" style="margin-top:6px;">
                <button id="resetBtn">אפס פילטרים</button>
              </div>
            </div>
          </div>

          <div class="chips" id="teamChips"></div>

          <div class="btns">
            <button class="primary" id="toggleGames">משחקים</button>
            <button id="toggleStandings">טבלה מלאה</button>
          </div>

          <div class="stats" id="statsBox"></div>
          <div class="err" id="errBox" style="display:none;"></div>
          <div class="diag" id="diagBox"></div>

          <div class="tables" id="tables">
            <div id="gamesWrap" style="display:block;">
              <div class="muted" style="margin: 6px 0 8px;">משחקים (מחזור / מול יריבה)</div>
              <div class="tableWrap">
                <table id="gamesTable"></table>
              </div>
            </div>
            <div id="standingsWrap" style="display:none;">
              <div class="muted" style="margin: 6px 0 8px;">טבלת הליגה (מלאה)</div>
              <div class="tableWrap noScroll">
                <table id="standingsTable"></table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="map">
        <div class="mapInner card">
          <div class="mapGrid"></div>
          <div class="mapTitle">
            <h2>מפת יריבות</h2>
            <div class="hint">לחץ על קבוצה כדי לראות משחקים • הקבוצה שלך במרכז</div>
          </div>
          <div id="lines"></div>
          <div id="nodes"></div>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  // Try multiple locations to avoid "empty page" when GitHub Pages path differs.
  const DATA_URLS = [
    "data.json",
    "./data.json",
    "../data.json",
    "/Galil/data.json"
  ].map(u => u + "?v=" + Date.now());

  const state = {
    data: null,
    rounds: [],
    roundOffset: 0,
    selectedRound: null,
    focusTeam: "הפ׳ גליל עליון",
    selectedOpponent: "",
    onlyTeam: false,
    chipTeam: "",
    dataUrlUsed: ""
  };

  const el = (id) => document.getElementById(id);

  function normKey(s){
    return (s||"")
      .toString()
      .trim()
      .replace(/[״"]/g,"")
      .replace(/[׳']/g,"")
      .replace(/[()]/g," ")
      .replace(/\s+/g," ")
      .toLowerCase();
  }
  function normalizeTeamName(s){ return (s||"").toString().trim().replace(/\s+/g," "); }

  function safeText(x){ return (x===null || x===undefined) ? "" : String(x); }

  function getStandings(){
    const s = Array.isArray(state.data?.standings) ? state.data.standings : [];
    if (s.length) return s;
    // fallback: build standings from games that have scores
    return computeStandingsFromGames(state.data?.games || []);
  }

  function getTeams(){
    const standings = getStandings();
    // dedupe by key to avoid "גליל עליון" twice (different apostrophes)
    const map = new Map();
    for (const r of standings){
      const name = normalizeTeamName(r?.name);
      const k = normKey(name);
      if (!k) continue;
      if (!map.has(k)) map.set(k, name);
    }
    return Array.from(map.values());
  }

  function findTeamKey(name){
    const target = normKey(name);
    if (!target) return "";
    const teams = getTeams();
    let best = teams.find(t => normKey(t) === target);
    if (best) return best;
    best = teams.find(t => normKey(t).includes(target) || target.includes(normKey(t)));
    return best || normalizeTeamName(name);
  }

  function computeRoundOffset(){
    const nums = state.rounds.map(r => Number(r.number)).filter(n => Number.isFinite(n));
    if (!nums.length){ state.roundOffset = 0; return; }
    const min = Math.min(...nums);
    state.roundOffset = (min === 0) ? 1 : 0;
  }
  function displayRound(n){
    const num = Number(n);
    return Number.isFinite(num) ? (num + state.roundOffset) : n;
  }
  function formatDateHeb(raw){
    if(!raw) return "";
    return String(raw).replace("T"," ").replace("Z","");
  }

  function isTeamMatch(a,b){
    const A = normKey(a), B = normKey(b);
    if(!A || !B) return false;
    return A===B || A.includes(B) || B.includes(A);
  }
  function isTeamInGame(game, team){
    const t = team;
    const home = game?.homeTeam?.name;
    const away = game?.awayTeam?.name;
    return isTeamMatch(home, t) || isTeamMatch(away, t);
  }
  function opponentOf(game, team){
    const home = game?.homeTeam?.name;
    const away = game?.awayTeam?.name;
    if (isTeamMatch(home, team)) return normalizeTeamName(away);
    if (isTeamMatch(away, team)) return normalizeTeamName(home);
    return "";
  }

  function scoreText(game){
    const hs = game?.homeTeam?.score;
    const as = game?.awayTeam?.score;
    const has = (hs!==null && hs!==undefined && hs!=="") || (as!==null && as!==undefined && as!=="");
    if(!has) return "—";
    return `${safeText(hs)} - ${safeText(as)}`;
  }

  function gameHasScore(g){
    const hs = g?.homeTeam?.score ?? g?.homeScore ?? g?.scoreHome;
    const as = g?.awayTeam?.score ?? g?.awayScore ?? g?.scoreAway;
    return (String(hs).match(/^\d+$/) && String(as).match(/^\d+$/));
  }
  function gameScoreStr(g){
    if(!gameHasScore(g)) return "";
    const hs = g?.homeTeam?.score ?? g?.homeScore ?? g?.scoreHome;
    const as = g?.awayTeam?.score ?? g?.awayScore ?? g?.scoreAway;
    return `${hs} : ${as}`;
  }
  function gameKeyDate(g){
    const iso = g?.dateISO || g?.datetimeISO || g?.dateTimeISO || g?.dateTime || g?.date;
    if (iso && !isNaN(Date.parse(iso))) return Date.parse(iso);
    const t = g?.dateText || "";
    const m = String(t).match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4}).*?(\d{1,2}):(\d{2})/);
    if(m){
      const dd=+m[1], mm=+m[2], yy=+m[3] + (m[3].length===2 ? 2000 : 0);
      const hh=+m[4], mi=+m[5];
      return Date.parse(`${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}T${String(hh).padStart(2,'0')}:${String(mi).padStart(2,'0')}:00`);
    }
    return 0;
  }

  function lastGameForTeam(teamName, games){
    const t = findTeamKey(teamName);
    const relevant = (games||[]).filter(g => isTeamInGame(g, t) && gameHasScore(g));
    if(!relevant.length) return null;
    relevant.sort((a,b)=> gameKeyDate(b) - gameKeyDate(a));
    return relevant[0];
  }

  function lastH2H(teamA, teamB, games){
    const A = findTeamKey(teamA);
    const B = findTeamKey(teamB);
    const relevant = (games||[]).filter(g => {
      const h = g?.homeTeam?.name;
      const a = g?.awayTeam?.name;
      const ok = (isTeamMatch(h,A) && isTeamMatch(a,B)) || (isTeamMatch(h,B) && isTeamMatch(a,A));
      return ok && gameHasScore(g);
    });
    if(!relevant.length) return null;
    relevant.sort((a,b)=> gameKeyDate(b) - gameKeyDate(a));
    return relevant[0];
  }

  function computeStandingsFromGames(games){
    const rows = new Map();
    const get = (name)=>{
      const k = normKey(name);
      if(!k) return null;
      if(!rows.has(k)){
        rows.set(k,{name:normalizeTeamName(name), played:0, w:0, d:0, l:0, gf:0, ga:0, gd:0, points:0});
      }
      return rows.get(k);
    };
    for(const g of (games||[])){
      const home = g?.homeTeam?.name || g?.home?.name || g?.home || "";
      const away = g?.awayTeam?.name || g?.away?.name || g?.away || "";
      if(!home || !away) continue;
      const hs = (g?.homeTeam?.score ?? g?.homeScore ?? g?.scoreHome);
      const as = (g?.awayTeam?.score ?? g?.awayScore ?? g?.scoreAway);
      const hsNum = (typeof hs === "number") ? hs : (String(hs||"").match(/^\d+$/) ? Number(hs) : null);
      const asNum = (typeof as === "number") ? as : (String(as||"").match(/^\d+$/) ? Number(as) : null);
      if(hsNum===null || asNum===null) continue;

      const H = get(home), A = get(away);
      if(!H || !A) continue;
      H.played++; A.played++;
      H.gf += hsNum; H.ga += asNum;
      A.gf += asNum; A.ga += hsNum;

      if(hsNum > asNum){ H.w++; A.l++; H.points += 2; }
      else if(hsNum < asNum){ A.w++; H.l++; A.points += 2; }
      else { H.d++; A.d++; H.points += 1; A.points += 1; }
    }
    const arr = Array.from(rows.values()).map(r=>({...r, gd:r.gf-r.ga}));
    arr.sort((a,b)=> (b.points-a.points) || (b.gd-a.gd) || (b.gf-a.gf) || a.name.localeCompare(b.name,"he"));
    arr.forEach((r,i)=>{ r.rank=i+1; r.position=i+1; r.pts=r.points; });
    return arr;
  }

  function leagueLine(){
    const m = state.data?.meta || {};
    const league = state.data?.league?.name || m?.leagueName || "";
    const season = m?.season || "";
    const fetchedAt = m?.fetchedAt || m?.last_update || "";
    const games = (state.data?.games || []).length;
    const rounds = state.rounds.length;
    return `${league} • ${season} • משחקים: ${games} • מחזורים: ${rounds} • עודכן: ${formatDateHeb(fetchedAt)}`;
  }

  function setErr(msg){
    const box = el("errBox");
    if(!msg){ box.style.display="none"; box.textContent=""; return; }
    box.style.display="block"; box.textContent = msg;
  }
  function setDiag(html){
    const box = el("diagBox");
    if(!html){ box.style.display="none"; box.innerHTML=""; return; }
    box.style.display="block"; box.innerHTML = html;
  }

  function buildChips(){
    const container = el("teamChips");
    container.innerHTML = "";
    const teams = getTeams();
    const focus = findTeamKey(state.focusTeam);

    const add = (label, key) => {
      const d = document.createElement("div");
      d.className = "chip" + ((state.chipTeam === key) ? " active" : "");
      d.textContent = label;
      d.onclick = () => { state.chipTeam = (state.chipTeam === key) ? "" : key; renderAll(); };
      container.appendChild(d);
    };

    add("הכל", "");
    add(focus, focus);
    teams.filter(t => !isTeamMatch(t, focus)).slice(0, 24).forEach(t => add(t, t));
  }

  function buildRoundSelect(){
    const sel = el("roundSelect");
    sel.innerHTML = "";
    state.rounds.forEach(r => {
      const opt = document.createElement("option");
      opt.value = String(r.number);
      opt.textContent = `מחזור ${displayRound(r.number)} (${r.gamesCount})`;
      sel.appendChild(opt);
    });
    if(state.selectedRound===null && state.rounds.length){ state.selectedRound = String(state.rounds[0].number); }
    sel.value = String(state.selectedRound ?? "");
    sel.onchange = () => { state.selectedRound = sel.value; renderAll(); };

    const prevBtn = el("roundPrev");
    const nextBtn = el("roundNext");
    const setDisabled = ()=>{
      const idx = state.rounds.findIndex(r => String(r.number)===String(state.selectedRound));
      prevBtn.disabled = idx<=0;
      nextBtn.disabled = idx<0 || idx>=state.rounds.length-1;
    };
    const go = (delta)=>{
      const idx = state.rounds.findIndex(r => String(r.number)===String(state.selectedRound));
      if(idx<0) return;
      const ni = Math.max(0, Math.min(state.rounds.length-1, idx+delta));
      state.selectedRound = String(state.rounds[ni].number);
      sel.value = state.selectedRound;
      renderAll();
      setDisabled();
    };
    prevBtn.onclick = ()=>go(-1);
    nextBtn.onclick = ()=>go(1);
    setDisabled();
  }

  function filteredGames(){
    const games = state.data?.games || [];
    const focus = findTeamKey(state.focusTeam);
    const opp = state.selectedOpponent ? findTeamKey(state.selectedOpponent) : "";
    const chip = state.chipTeam ? findTeamKey(state.chipTeam) : "";
    const onlyTeam = !!state.onlyTeam;
    const round = state.selectedRound;

    let g = games.filter(x => String(x?.round?.number) === String(round));

    if(onlyTeam){ g = g.filter(x => isTeamInGame(x, focus)); }
    if(chip){ g = g.filter(x => isTeamInGame(x, chip)); }
    if(opp){
      g = g.filter(x => (isTeamInGame(x, opp) && isTeamInGame(x, focus)));
    }

    const q = normalizeTeamName(el("teamInput").value);
    if(q){
      const qk = normKey(q);
      g = g.filter(x => normKey(x?.homeTeam?.name).includes(qk) || normKey(x?.awayTeam?.name).includes(qk));
    }

    g.sort((a,b)=> gameKeyDate(a) - gameKeyDate(b));
    return g;
  }

  function renderGamesTable(){
    const tbl = el("gamesTable");
    const g = filteredGames();
    const rows = [];
    rows.push(`<thead><tr>
      <th>תאריך</th><th>בית</th><th>תוצאה</th><th>חוץ</th><th>מיקום</th>
    </tr></thead>`);
    rows.push("<tbody>");
    if(!g.length){
      rows.push(`<tr><td colspan="5" class="muted">אין משחקים לתצוגה לפי הסינון הנוכחי</td></tr>`);
    } else {
      for(const game of g){
        const date = game?.dateText || formatDateHeb(game?.date || "");
        const home = normalizeTeamName(game?.homeTeam?.name);
        const away = normalizeTeamName(game?.awayTeam?.name);
        const loc = normalizeTeamName(game?.field?.name || game?.location || "");
        rows.push(`<tr>
          <td>${safeText(date)}</td>
          <td>${safeText(home)}</td>
          <td><b>${scoreText(game)}</b></td>
          <td>${safeText(away)}</td>
          <td class="muted">${safeText(loc)}</td>
        </tr>`);
      }
    }
    rows.push("</tbody>");
    tbl.innerHTML = rows.join("");
  }

  function renderStandingsTable(){
    const tbl = el("standingsTable");
    const s = getStandings();
    const focus = findTeamKey(state.focusTeam);

    const rows = [];
    rows.push(`<thead><tr>
      <th>#</th><th>קבוצה</th><th>נק'</th><th>מש</th><th>נ</th><th>ה</th><th>ת</th><th>+</th><th>-</th><th>הפרש</th>
    </tr></thead>`);
    rows.push("<tbody>");
    for(const r of s){
      const name = normalizeTeamName(r.name);
      const isFocus = isTeamMatch(name, focus);
      const pts = r.points ?? r.pts ?? "";
      const played = r.games ?? r.played ?? "";
      const w = r.w ?? r.wins ?? "";
      const l = r.l ?? r.losses ?? "";
      const d = r.d ?? r.draws ?? "";
      const gf = r.gf ?? "";
      const ga = r.ga ?? "";
      const gd = r.gd ?? (gf!=="" && ga!=="" ? (Number(gf)-Number(ga)) : "");
      rows.push(`<tr style="${isFocus ? 'background: rgba(58,167,255,.10);' : ''}">
        <td>${r.rank ?? r.position ?? ""}</td>
        <td><b>${safeText(name)}</b></td>
        <td><b>${safeText(pts)}</b></td>
        <td>${safeText(played)}</td>
        <td>${safeText(w)}</td>
        <td>${safeText(l)}</td>
        <td>${safeText(d)}</td>
        <td>${safeText(gf)}</td>
        <td>${safeText(ga)}</td>
        <td>${safeText(gd)}</td>
      </tr>`);
    }
    rows.push("</tbody>");
    tbl.innerHTML = rows.join("");
  }

  function renderStats(){
    const box = el("statsBox");
    const focus = findTeamKey(state.focusTeam);
    const opp = state.selectedOpponent ? findTeamKey(state.selectedOpponent) : "";
    const round = displayRound(state.selectedRound ?? "");
    const shown = filteredGames().length;

    const last = lastGameForTeam(focus, state.data?.games || []);
    const lastOpp = opp ? lastH2H(focus, opp, state.data?.games || []) : null;

    const lastLine = last
      ? `משחק אחרון: <b>${opponentOf(last, focus)}</b> — <b>${gameScoreStr(last)}</b> <span class="muted">(${safeText(last.dateText || "")})</span>`
      : `משחק אחרון: <span class="muted">אין תוצאה קודמת</span>`;

    const lastOppLine = opp
      ? (lastOpp
          ? `מפגש אחרון מול <b>${opp}</b>: <b>${gameScoreStr(lastOpp)}</b> <span class="muted">(${safeText(lastOpp.dateText || "")})</span>`
          : `מפגש אחרון מול <b>${opp}</b>: <span class="muted">אין תוצאה</span>`)
      : `מפגש אחרון מול יריבה: <span class="muted">לא נבחרה</span>`;

    box.innerHTML = [
      `קבוצה במרכז: <b>${focus}</b>`,
      opp ? `יריבה נבחרת: <b>${opp}</b>` : `יריבה נבחרת: <span class="muted">לא נבחרה</span>`,
      `מחזור: <b>${round}</b>`,
      `משחקים מוצגים: <b>${shown}</b>`,
      lastLine,
      lastOppLine
    ].join("<br/>");
  }

  function renderMap(){
    const nodesEl = el("nodes");
    const linesEl = el("lines");
    nodesEl.innerHTML = "";
    linesEl.innerHTML = "";

    const teams = getTeams();
    const focus = findTeamKey(state.focusTeam);
    if(!teams.length) return;

    // Center node
    const center = document.createElement("div");
    center.className = "node center";
    center.style.left = "50%";
    center.style.top = "55%";

    const focusStanding = getStandings().find(x => isTeamMatch(x.name, focus));
    const pts = focusStanding?.points ?? focusStanding?.pts ?? "—";
    const rank = focusStanding?.rank ?? focusStanding?.position ?? "—";
    const last = lastGameForTeam(focus, state.data?.games || []);
    const lastTxt = last ? `${opponentOf(last, focus)} • ${gameScoreStr(last)}${last.dateText ? " • " + last.dateText : ""}` : "אין משחק אחרון";

    center.innerHTML = `<div class="name">${focus}</div>
      <div class="meta"><span>מקום ${safeText(rank)}</span><span>${safeText(pts)} נק׳</span></div>
      <div class="meta2">משחק אחרון: ${safeText(lastTxt)}</div>
      <div class="cta">הקבוצה שלנו (לחץ לאיפוס יריבה)</div>`;
    center.onclick = () => { state.selectedOpponent = ""; renderAll(); };
    nodesEl.appendChild(center);

    // Others
    const others = teams.filter(t => !isTeamMatch(t, focus));
    const count = others.length;
    const radiusX = 310, radiusY = 230;
    const cx = 0.5, cy = 0.55;

    const getPos = (i)=>{
      const a = (i / Math.max(1,count)) * Math.PI * 2;
      return { a, x: cx + (Math.cos(a)*radiusX)/1000, y: cy + (Math.sin(a)*radiusY)/720 };
    };

    others.forEach((team, i)=>{
      const p = getPos(i);
      const left = (p.x*100) + "%";
      const top  = (p.y*100) + "%";
      const st = getStandings().find(x => isTeamMatch(x.name, team));
      const lastVs = lastH2H(focus, team, state.data?.games || []);
      const lastVsTxt = lastVs ? `${gameScoreStr(lastVs)}${lastVs.dateText ? " • " + lastVs.dateText : ""}` : "אין תוצאה";

      const line = document.createElement("div");
      line.className = "line";
      line.dataset.to = JSON.stringify({x:left,y:top});
      linesEl.appendChild(line);

      const d = document.createElement("div");
      d.className = "node";
      d.style.left = left;
      d.style.top = top;
      d.innerHTML = `<div class="name">${team}</div>
        <div class="meta"><span>מקום ${safeText(st?.rank ?? st?.position ?? "—")}</span><span>${safeText(st?.points ?? st?.pts ?? "—")} נק׳</span></div>
        <div class="meta2">מפגש אחרון: ${safeText(lastVsTxt)}</div>
        <div class="cta">לחץ לצפייה</div>`;
      d.onclick = ()=>{ state.selectedOpponent = team; renderAll(); };
      nodesEl.appendChild(d);
    });

    requestAnimationFrame(()=>{
      const map = document.querySelector(".mapInner");
      const rect = map.getBoundingClientRect();
      const centerX = rect.width * 0.5;
      const centerY = rect.height * 0.55;
      for(const line of linesEl.querySelectorAll(".line")){
        const to = JSON.parse(line.dataset.to);
        const xPct = parseFloat(String(to.x).replace("%",""))/100;
        const yPct = parseFloat(String(to.y).replace("%",""))/100;
        const x2 = rect.width * xPct;
        const y2 = rect.height * yPct;
        const dx = x2 - centerX, dy = y2 - centerY;
        const len = Math.sqrt(dx*dx + dy*dy);
        const ang = Math.atan2(dy, dx);
        line.style.left = centerX + "px";
        line.style.top  = centerY + "px";
        line.style.width = len + "px";
        line.style.transform = `rotate(${ang}rad)`;
      }
    });
  }

  function renderAll(){
    state.onlyTeam = el("onlyTeam").checked;
    renderStats();
    renderGamesTable();
    renderStandingsTable();
    renderMap();
    buildChips();

    const m = state.data?.meta || {};
    const ver = m?.version ? `v${m.version}` : "";
    const fetched = m?.fetchedAt || m?.last_update || "";
    el("metaSmall").textContent = `${ver}${fetched ? " • " + formatDateHeb(fetched) : ""}`;
  }

  function setup(){
    el("toggleGames").onclick = ()=>{ el("gamesWrap").style.display="block"; el("standingsWrap").style.display="none"; };
    el("toggleStandings").onclick = ()=>{ el("gamesWrap").style.display="none"; el("standingsWrap").style.display="block"; };
    el("resetBtn").onclick = ()=>{
      state.selectedOpponent=""; state.chipTeam="";
      el("teamInput").value=""; el("onlyTeam").checked=false;
      renderAll();
    };
    el("teamInput").addEventListener("input", ()=>renderAll());
    el("onlyTeam").addEventListener("change", ()=>renderAll());
  }

  async function fetchJsonAny(){
    const tries = [];
    for(const url of DATA_URLS){
      try{
        const res = await fetch(url, { cache:"no-store" });
        tries.push({url, ok:res.ok, status:res.status});
        if(res.ok){
          state.dataUrlUsed = url.replace(/\?v=.*$/,"");
          return await res.json();
        }
      }catch(e){
        tries.push({url, ok:false, err:String(e?.message||e)});
      }
    }
    const diag = tries.map(t => `• <code>${t.url}</code> → ${t.ok ? "OK" : ("FAIL " + (t.status||t.err||""))}`).join("<br/>");
    setDiag(`<b>ניסיתי לטעון data.json מכמה כתובות:</b><br/>${diag}<br/><span class="muted">אם הכל FAIL — כנראה ש־data.json לא נמצא בפרסום של GitHub Pages או לא הועלה.</span>`);
    throw new Error("Failed to fetch data.json");
  }

  async function load(){
    setup();
    try{
      state.data = await fetchJsonAny();

      // Build rounds: meta.roundsFetched OR from games
      const metaRounds = state.data?.meta?.roundsFetched;
      if(Array.isArray(metaRounds) && metaRounds.length){
        state.rounds = metaRounds.map(r => ({number:String(r.number), gamesCount:Number(r.gamesCount||0)}));
      } else {
        const by = new Map();
        for(const g of (state.data?.games||[])){
          const n = String(g?.round?.number ?? "");
          if(!n) continue;
          by.set(n, (by.get(n)||0)+1);
        }
        state.rounds = Array.from(by.entries()).map(([number,gamesCount])=>({number, gamesCount}))
          .sort((a,b)=> Number(a.number)-Number(b.number));
      }

      computeRoundOffset();
      buildRoundSelect();
      el("leagueLine").textContent = leagueLine();
      setErr("");
      setDiag(state.dataUrlUsed ? `<b>data.json נטען מ:</b> <code>${state.dataUrlUsed}</code>` : "");
      renderAll();
    }catch(e){
      console.error(e);
      setErr("לא הצלחתי לטעון את data.json. אם אתה פותח דרך file:// זה לא יעבוד — פתח דרך Live Server או GitHub Pages. " +
             "אם אתה ב־GitHub Pages ועדיין אין נתונים — כנראה שחסר data.json בפרסום.\nשגיאה: " + (e?.message||e));
      el("leagueLine").textContent = "שגיאה בטעינה";
    }
  }

  load();
})();
</script>
</body>
</html>
