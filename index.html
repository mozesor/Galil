<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>גליל – לוח משחקים</title>
  <style>
:root{
  --bg1:#071a3a;
  --bg2:#0b4db8;
  --card:#ffffff;
  --text:#0b1020;
  --muted:#5b647a;
  --line:#e6eaf2;
  --accent:#1f6bff;
  --accent2:#00c2ff;
  --shadow:0 10px 30px rgba(0,0,0,0.12);
  --radius:16px;
  --radius2:22px;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Hebrew", "Noto Sans", sans-serif;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  direction:rtl;
  background:
    radial-gradient(1200px 600px at 15% 0%, rgba(0,194,255,0.22), transparent 55%),
    radial-gradient(900px 500px at 85% 0%, rgba(31,107,255,0.25), transparent 60%),
    linear-gradient(180deg, var(--bg1), #0a2a63 55%, #f2f6ff 55%, #f2f6ff 100%);
}

.bg-art{
  position:fixed;
  inset:0;
  background:url("assets/bg-tree.svg") no-repeat top center;
  background-size:cover;
  pointer-events:none;
  opacity:0.55;
  mix-blend-mode:screen;
}
.container{max-width:1200px;margin:24px auto;padding:0 16px;position:relative}
.card{
  background:rgba(255,255,255,0.92);
  backdrop-filter: blur(10px);
  border:1px solid rgba(230,234,242,0.9);
  border-radius:var(--radius2);
  box-shadow:var(--shadow);
  padding:18px 18px 14px;
}
.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  margin-bottom:14px;
  padding:18px 18px 16px;
  border-radius:var(--radius2);
  background:linear-gradient(135deg, rgba(31,107,255,0.92), rgba(0,194,255,0.72));
  color:#fff;
  box-shadow:0 12px 30px rgba(0,0,0,0.18);
  border:1px solid rgba(255,255,255,0.18);
}
.topbar h1{margin:0;font-size:22px;letter-spacing:0.2px}
.subnote{margin-top:6px;font-size:13px;opacity:0.9}
.badges{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,0.18);
  border:1px solid rgba(255,255,255,0.24);
  color:#fff;
  font-size:12px;
  white-space:nowrap;
}
.badge a{color:#fff;text-decoration:none}
.badge a:hover{text-decoration:underline}

.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px}
.controls label{font-size:13px;color:#0b1020;opacity:0.9}
.controls select,.controls input[type="text"]{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  min-width:220px;
  outline:none;
}
.controls input[type="checkbox"]{transform:scale(1.15);margin-left:6px}
.controls button{
  padding:10px 14px;
  border:0;
  border-radius:12px;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  color:#fff;
  cursor:pointer;
  box-shadow:0 10px 18px rgba(31,107,255,0.22);
  font-weight:700;
}
.controls button:hover{filter:brightness(1.03)}
.controls button:active{transform:translateY(1px)}
.row{display:grid;grid-template-columns:1fr 1.6fr;gap:16px;margin-top:16px}
@media (max-width: 980px){.row{grid-template-columns:1fr}}

.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:var(--radius);background:#fff}
table{width:100%;border-collapse:collapse;min-width:560px}
th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:right;vertical-align:middle}
th{background:#f6f9ff;color:#0b1020;font-size:13px;position:sticky;top:0;z-index:1}
tbody tr:hover{background:#f2f7ff}
tbody tr.me{background:linear-gradient(90deg, rgba(31,107,255,0.12), rgba(0,194,255,0.06))}
.small{font-size:12px;color:var(--muted)}
.kpi{display:inline-flex;align-items:center;gap:8px;margin-top:10px}
.kpi .pill{padding:6px 10px;border-radius:999px;background:#eef5ff;border:1px solid #dbe8ff;color:#123b8f;font-size:12px}

hr.sep{border:none;border-top:1px dashed rgba(255,255,255,0.35);margin:12px 0 0}

</style>
</head>
<body>
  <div class="bg-art" aria-hidden="true"></div>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>גליל – לוח משחקים</h1>
        <div class="sub">
          הנתונים נטענים מקובץ <code>data.json</code> (מתעדכן ע"י GitHub Actions).
          בדיקה מקומית: חובה לפתוח דרך שרת (לא file://).
        </div>
      </div>
      <div class="row">
        <span class="pill">GitHub Pages</span>
        <button id="reload">רענן</button>
        <a class="pill" id="dbgLink" href="./debug_endpoints.json" target="_blank">debug_endpoints.json</a>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row">
        <label>בחר מחזור:
          <select id="roundSelect"></select>
        </label>

        <label>הדגש קבוצה:
          <input id="teamFilter" placeholder="לדוגמה: גליל עליון" value="גליל" />
        </label>

        <label class="tiny">
          <input type="checkbox" id="onlyTeam" />
          רק משחקים של הקבוצה
        </label>

        <span class="pill" id="meta">טוען…</span>
      </div>

      <div id="errorBox" class="err" style="display:none;"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 10px 0;">משחקים</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>תאריך</th>
                <th>בית</th>
                <th>תוצאה</th>
                <th>חוץ</th>
                <th>מיקום</th>
              </tr>
            </thead>
            <tbody id="gamesBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0;">טבלה</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>קבוצה</th>
                <th>נק׳</th>
                <th>מש</th>
                <th>+</th>
                <th>-</th>
                <th>הפרש</th>
              </tr>
            </thead>
            <tbody id="standBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  let DATA = null;

  function fmtDate(s){
    if(!s) return "";
    try{
      const d = new Date(s);
      return d.toLocaleString("he-IL", { weekday:"short", year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return s; }
  }

  function includesTeam(game, q){
    if(!q) return false;
    const t = q.toLowerCase();
    const h = (game.home?.name || "").toLowerCase();
    const a = (game.away?.name || "").toLowerCase();
    return h.includes(t) || a.includes(t);
  }

  function showError(msg){
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.innerHTML = msg;
  }
  function hideError(){
    const box = document.getElementById("errorBox");
    box.style.display = "none";
    box.innerHTML = "";
  }

  async function load(){
    hideError();
    try{
      const r = await fetch("./data.json?ts=" + Date.now());
      if(!r.ok){
        const t = await r.text();
        throw new Error("HTTP " + r.status + " " + r.statusText + "<br><pre style='white-space:pre-wrap'>" + (t.slice(0,400)) + "</pre>");
      }
      DATA = await r.json();

      const leagueName = DATA?.league?.name || "ליגה";
      const fetchedAt = DATA?.fetchedAt || "";
      const roundsCount = DATA?.rounds?.length || 0;
      const gamesCount = DATA?.gamesCount || 0;
      const shift = DATA?.api?.roundNumberShiftApplied ?? DATA?.api?.roundNumberFixApplied ?? 0;

      document.getElementById("meta").textContent =
        `${leagueName} • מחזורים: ${roundsCount} • משחקים: ${gamesCount} • עודכן: ${fmtDate(fetchedAt)} ${shift ? "• תיקון מחזורים +1" : ""}`;

      const rs = (DATA.rounds || []).slice().sort((a,b)=>(a.number||0)-(b.number||0));
      const sel = document.getElementById("roundSelect");
      sel.innerHTML = "";
      for(const rr of rs){
        const opt = document.createElement("option");
        opt.value = rr.number;
        opt.textContent = `מחזור ${rr.number} (${rr.gamesCount || 0})`;
        sel.appendChild(opt);
      }

      const cur = DATA?.league?.currentRoundNumber;
      if(cur) sel.value = String(cur);
      if(!sel.value && rs.length) sel.value = String(rs[0].number);

      render();
    }catch(e){
      showError(
        `<b>לא הצלחתי לטעון נתונים.</b><br>
         אם פתחת את הקובץ דרך <code>file://</code> זה לא יעבוד – פתח דרך שרת (GitHub Pages / Live Server).<br><br>
         שגיאה: <code>${String(e).replaceAll("<","&lt;").replaceAll(">","&gt;")}</code>`
      );
      document.getElementById("meta").textContent = "אין נתונים";
      DATA = null;
      document.getElementById("roundSelect").innerHTML = "";
      document.getElementById("gamesBody").innerHTML = "";
      document.getElementById("standBody").innerHTML = "";
    }
  }

  function render(){
    if(!DATA) return;

    const roundNo = Number(document.getElementById("roundSelect").value);
    const teamQ = document.getElementById("teamFilter").value.trim();
    const onlyTeam = document.getElementById("onlyTeam").checked;

    let games = (DATA.games || []).filter(g => (g.round?.number ?? null) === roundNo);
    games.sort((a,b)=>(a.date||"").localeCompare(b.date||""));

    if(onlyTeam && teamQ) games = games.filter(g => includesTeam(g, teamQ));
    if(teamQ){
      games.sort((a,b)=>(includesTeam(b,teamQ)-includesTeam(a,teamQ)) || (a.date||"").localeCompare(b.date||""));
    }

    const body = document.getElementById("gamesBody");
    body.innerHTML = "";
    for(const g of games){
      const tr = document.createElement("tr");
      const isTeam = includesTeam(g, teamQ);
      const score = (g.home?.goals ?? "") + (g.is_finished ? " - " : " vs ") + (g.away?.goals ?? "");
      tr.innerHTML = `
        <td>${fmtDate(g.date)}</td>
        <td>${g.home?.name || ""}</td>
        <td><b>${score}</b></td>
        <td>${g.away?.name || ""}</td>
        <td class="tiny">${g.venue || ""}</td>
      `;
      if(isTeam) tr.className = "hl";
      body.appendChild(tr);
    }

    const sb = document.getElementById("standBody");
    sb.innerHTML = "";
    for(const t of (DATA.standings || [])){
      const tr = document.createElement("tr");
      const isTeam = teamQ && (t.name || "").toLowerCase().includes(teamQ.toLowerCase());
      tr.innerHTML = `
        <td>${t.rank ?? ""}</td>
        <td>${t.name ?? ""}</td>
        <td><b>${t.points ?? ""}</b></td>
        <td>${t.games ?? ""}</td>
        <td>${t.gf ?? ""}</td>
        <td>${t.ga ?? ""}</td>
        <td>${t.gd ?? ""}</td>
      `;
      if(isTeam) tr.className = "hl2";
      sb.appendChild(tr);
    }
  }

  document.getElementById("reload").onclick = load;
  document.getElementById("roundSelect").onchange = render;
  document.getElementById("teamFilter").oninput = render;
  document.getElementById("onlyTeam").onchange = render;

  load();
</script>
</body>
</html>
