<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>גליל - בדיקה מקומית</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; line-height: 1.35; margin:0; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .top { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content: space-between; }
    .card { background:#f7f7f7; border:1px solid #e5e5e5; border-radius: 14px; padding: 12px; }
    button, select, input { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 14px; }
    button { cursor:pointer; }
    .muted { opacity: .8; font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #e3e3e3; text-align:right; }
    th { position: sticky; top: 0; background: #fafafa; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#eef; font-size:12px; }
    .rowFlex { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { background:#eef; padding: 6px 10px; border-radius: 999px; }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h2 style="margin:0 0 6px 0;">גליל - לוח משחקים מקומי</h2>
        <div class="muted">הנתונים נטענים מ־<code>public/data.json</code> אחרי הרצת <b>npm run fetch</b></div>
      </div>
      <div class="rowFlex">
        <span class="pill">URL: <b>http://localhost:5173</b></span>
        <button id="reload">רענן</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="rowFlex">
        <label>בחר מחזור:
          <select id="roundSelect"></select>
        </label>

        <label>הדגש קבוצה:
          <input id="teamFilter" placeholder="לדוגמה: גליל עליון" value="גליל" />
        </label>

        <label class="small">
          <input type="checkbox" id="onlyTeam" />
          רק משחקים של הקבוצה
        </label>

        <span class="tag" id="metaTag">טוען...</span>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="gamesCard">
        <h3 style="margin:0 0 10px 0;">משחקים</h3>
        <div style="overflow:auto; max-height: 70vh;">
          <table>
            <thead>
              <tr>
                <th>תאריך</th>
                <th>בית</th>
                <th>תוצאה</th>
                <th>חוץ</th>
                <th>מיקום</th>
              </tr>
            </thead>
            <tbody id="gamesBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0;">טבלה</h3>
        <div style="overflow:auto; max-height: 70vh;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>קבוצה</th>
                <th>נק׳</th>
                <th>מש</th>
                <th>+</th>
                <th>-</th>
                <th>הפרש</th>
              </tr>
            </thead>
            <tbody id="standBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  function fmtDate(s) {
    if (!s) return "";
    try {
      const d = new Date(s);
      return d.toLocaleString("he-IL", { weekday:"short", year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    } catch { return s; }
  }

  function includesTeam(game, q) {
    if (!q) return false;
    const t = q.toLowerCase();
    const h = (game.home?.name || "").toLowerCase();
    const a = (game.away?.name || "").toLowerCase();
    return h.includes(t) || a.includes(t);
  }

  let DATA = null;

  async function load() {
    const r = await fetch("/data.json?ts=" + Date.now());
    DATA = await r.json();

    const leagueName = DATA?.league?.name || "ליגה";
    const fetchedAt = DATA?.fetchedAt || "";
    const roundsCount = DATA?.rounds?.length || 0;
    const gamesCount = DATA?.gamesCount || 0;
    const shift = DATA?.api?.roundNumberShiftApplied ?? 0;

    document.getElementById("metaTag").textContent =
      `${leagueName} • מחזורים: ${roundsCount} • משחקים: ${gamesCount} • עודכן: ${fmtDate(fetchedAt)} ${shift ? "• תיקון מחזורים +1" : ""}`;

    const rs = (DATA.rounds || []).slice().sort((a,b)=> (a.number||0) - (b.number||0));
    const sel = document.getElementById("roundSelect");
    sel.innerHTML = "";
    for (const r of rs) {
      const opt = document.createElement("option");
      opt.value = r.number;
      opt.textContent = `מחזור ${r.number} (${r.gamesCount || 0})`;
      sel.appendChild(opt);
    }

    const cur = DATA?.league?.currentRoundNumber;
    if (cur) sel.value = String(cur);

    render();
  }

  function render() {
    if (!DATA) return;

    const roundNo = Number(document.getElementById("roundSelect").value);
    const teamQ = document.getElementById("teamFilter").value.trim();
    const onlyTeam = document.getElementById("onlyTeam").checked;

    const gamesAll = DATA.games || [];
    let games = gamesAll.filter(g => (g.round?.number ?? null) === roundNo);

    games.sort((a,b)=> (a.date||"").localeCompare(b.date||""));

    if (onlyTeam && teamQ) games = games.filter(g => includesTeam(g, teamQ));

    if (teamQ) {
      games.sort((a,b)=> (includesTeam(b, teamQ) - includesTeam(a, teamQ)) || (a.date||"").localeCompare(b.date||""));
    }

    const body = document.getElementById("gamesBody");
    body.innerHTML = "";
    for (const g of games) {
      const tr = document.createElement("tr");
      const isTeam = includesTeam(g, teamQ);

      const score = (g.home?.goals ?? "") + (g.is_finished ? " - " : " vs ") + (g.away?.goals ?? "");
      tr.innerHTML = `
        <td>${fmtDate(g.date)}</td>
        <td>${g.home?.name || ""}</td>
        <td><b>${score}</b></td>
        <td>${g.away?.name || ""}</td>
        <td class="small">${g.venue || ""}</td>
      `;
      if (isTeam) tr.style.background = "#fff7d6";
      body.appendChild(tr);
    }

    const sb = document.getElementById("standBody");
    sb.innerHTML = "";
    for (const t of (DATA.standings || [])) {
      const tr = document.createElement("tr");
      const isTeam = teamQ && (t.name || "").toLowerCase().includes(teamQ.toLowerCase());
      tr.innerHTML = `
        <td>${t.rank ?? ""}</td>
        <td>${t.name ?? ""}</td>
        <td><b>${t.points ?? ""}</b></td>
        <td>${t.games ?? ""}</td>
        <td>${t.gf ?? ""}</td>
        <td>${t.ga ?? ""}</td>
        <td>${t.gd ?? ""}</td>
      `;
      if (isTeam) tr.style.background = "#dff7ff";
      sb.appendChild(tr);
    }
  }

  document.getElementById("reload").onclick = load;
  document.getElementById("roundSelect").onchange = render;
  document.getElementById("teamFilter").oninput = render;
  document.getElementById("onlyTeam").onchange = render;

  load();
</script>
</body>
</html>
